# ==============================================================================
# Proxmox Backup – Esempio di configurazione (backup.env)
# Copia questo file, adatta i valori e mantienilo fuori dal controllo versione.
# ==============================================================================

# ----------------------------------------------------------------------
# Impostazioni generali
# ----------------------------------------------------------------------
BACKUP_ENABLED=true
ENABLE_GO_BACKUP=true
USE_COLOR=true
COLORIZE_STEP_LOGS=true      # Highlight "Step N/7" lines (requires USE_COLOR=true)
DEBUG_LEVEL=standard        # standard | advanced | extreme
DRY_RUN=true                # Metti a false per esecuzioni reali

# ----------------------------------------------------------------------
# Sicurezza
# ----------------------------------------------------------------------
SECURITY_CHECK_ENABLED=true
AUTO_UPDATE_HASHES=true
AUTO_FIX_PERMISSIONS=true
CONTINUE_ON_SECURITY_ISSUES=false      # Metti a true per ignorare warning (default: blocca il backup)
CHECK_NETWORK_SECURITY=false
CHECK_FIREWALL=false
CHECK_OPEN_PORTS=false
SUSPICIOUS_PORTS="6666 6665 1337 31337 4444 5555 4242 6324 8888 2222 3389 5900"
PORT_WHITELIST=                     # Formato: servizio:porta (es. sshd:22,nginx:443)
SUSPICIOUS_PROCESSES="ncat,cryptominer,xmrig,kdevtmpfsi,kinsing,minerd,mr.sh"
SAFE_BRACKET_PROCESSES="sshd:,systemd,cron,rsyslogd,dbus-daemon"

# ----------------------------------------------------------------------
# Disk space
# ----------------------------------------------------------------------
MIN_DISK_SPACE_PRIMARY_GB=1
MIN_DISK_SPACE_SECONDARY_GB=1
MIN_DISK_SPACE_CLOUD_GB=1

# ----------------------------------------------------------------------
# Percorsi locali
# ----------------------------------------------------------------------
# BASE_DIR=/opt/proxmox-backup
BACKUP_PATH=${BASE_DIR}/backup-test
LOG_PATH=${BASE_DIR}/log-test
LOCK_PATH=${BASE_DIR}/lock
SECURE_ACCOUNT=${BASE_DIR}/secure_account

# ----------------------------------------------------------------------
# Compressione
# ----------------------------------------------------------------------
COMPRESSION_TYPE=xz         # none | gzip | xz | zstd
COMPRESSION_LEVEL=9         # gzip/pigz/bzip2:1-9, xz/lzma:0-9, zstd:1-22
COMPRESSION_THREADS=0       # 0 = auto, >0 forza numero thread per pigz/xz/zstd
COMPRESSION_MODE=ultra   # fast | standard | maximum | ultra (maximum/ultra regolano livello/flag extra)

# ----------------------------------------------------------------------
# Ottimizzazioni avanzate
# ----------------------------------------------------------------------
ENABLE_SMART_CHUNKING=true
ENABLE_DEDUPLICATION=true
ENABLE_PREFILTER=true
CHUNK_THRESHOLD_MB=50
CHUNK_SIZE_MB=10
PREFILTER_MAX_FILE_SIZE_MB=8

# ----------------------------------------------------------------------
# Preflight di rete (bypass per ambienti offline)
# ----------------------------------------------------------------------
# Se true, salta il controllo di connettività prima di usare funzionalità
# che richiedono la rete (Telegram, Email relay, Webhook, Cloud/rclone).
# Usa solo per test offline: potrebbe fallire comunque durante le operazioni.
DISABLE_NETWORK_PREFLIGHT=false

# ----------------------------------------------------------------------
# Esclusioni raccolta (pattern glob separati da spazi/virgole)
# ----------------------------------------------------------------------
# Esempio: *.log, */cache/**, /var/tmp/**
BACKUP_EXCLUDE_PATTERNS= */cache/**, /var/tmp/**

# ----------------------------------------------------------------------
# Storage secondario (fase 4 – lascia disabilitato se non usato)
# ----------------------------------------------------------------------
SECONDARY_ENABLED=true
SECONDARY_PATH=/opt/secondary-backup-go/backup-secondary-test

# ----------------------------------------------------------------------
# Cloud storage (fase 4 – rclone richiesto)
# ----------------------------------------------------------------------
CLOUD_ENABLED=false
CLOUD_REMOTE=rclone-remote:pbs-backups

# ----------------------------------------------------------------------
# Politiche di retention (numero massimo di backup da mantenere)
# ----------------------------------------------------------------------
MAX_LOCAL_BACKUPS=7
MAX_SECONDARY_BACKUPS=14
MAX_CLOUD_BACKUPS=30

# ----------------------------------------------------------------------
# Rclone settings (per cloud storage)
# ----------------------------------------------------------------------
# Timeout CONNECTION: verifica accessibilità remota (breve)
# Timeout OPERATION: upload/download completi (lungo)
RCLONE_TIMEOUT_CONNECTION=30     # secondi
RCLONE_TIMEOUT_OPERATION=300     # secondi
RCLONE_BANDWIDTH_LIMIT=          # es: "10M" per 10 MB/s, vuoto = illimitato
RCLONE_TRANSFERS=4               # trasferimenti paralleli
RCLONE_RETRIES=3                 # tentativi di retry
RCLONE_VERIFY_METHOD=primary     # primary | alternative

# ----------------------------------------------------------------------
# Batch deletion (cloud storage - evita limiti API)
# ----------------------------------------------------------------------
CLOUD_BATCH_SIZE=20              # file per batch
CLOUD_BATCH_PAUSE=1              # secondi tra batch

# ----------------------------------------------------------------------
# Bundle associated files (raggruppa backup + checksum + metadata)
# ----------------------------------------------------------------------
BUNDLE_ASSOCIATED_FILES=true     # true = crea bundle.tar con compressione=0
ENCRYPT_ARCHIVE=true            # true = cifra in streaming l'archivio principale (tar/.xz) durante la creazione
AGE_RECIPIENT=                   # (opzionale) recipient AGE inline; se vuoto il wizard chiede una chiave pubblica, oppure genera una chiave deterministica dalla tua passphrase (password non memorizzata, viene salvata solo la chiave pubblica)
AGE_RECIPIENT_FILE=${BASE_DIR}/identity/age/recipient.txt  # file con uno o più recipient (creato dallo wizard al primo avvio)

# ----------------------------------------------------------------------
# Notifiche (fase 5.1 – Telegram + Email)
# ----------------------------------------------------------------------

# Telegram Notifications
TELEGRAM_ENABLED=true
BOT_TELEGRAM_TYPE=centralized          # "centralized" or "personal"
TELEGRAM_BOT_TOKEN=                    # For personal mode only
TELEGRAM_CHAT_ID=                      # For personal mode only

# Email Notifications
EMAIL_ENABLED=true
EMAIL_DELIVERY_METHOD=relay            # "relay" or "sendmail"
EMAIL_FALLBACK_SENDMAIL=true           # Fallback to sendmail if relay fails
EMAIL_RECIPIENT=                       # Leave empty for auto-detection from Proxmox
EMAIL_FROM=no-reply@proxmox.tis24.it

# ----------------------------------------------------------------------
# Notifiche Webhook (fase 5.2 – Discord/Slack/Teams/Generic)
# ----------------------------------------------------------------------
WEBHOOK_ENABLED=false
WEBHOOK_ENDPOINTS=                     # comma-separated names es: discord_alerts,teams_ops
WEBHOOK_FORMAT=generic                 # default format for endpoints without esplicit format
WEBHOOK_TIMEOUT=30                     # seconds
WEBHOOK_MAX_RETRIES=3
WEBHOOK_RETRY_DELAY=2                  # seconds

# Per ogni endpoint usa il nome (maiuscolo) come prefisso, es. "discord_alerts":
# WEBHOOK_DISCORD_ALERTS_URL=https://discord.com/api/webhooks/XXXX/YYY
# WEBHOOK_DISCORD_ALERTS_FORMAT=discord   # discord | slack | teams | generic
# WEBHOOK_DISCORD_ALERTS_METHOD=POST      # POST consigliato; GET/HEAD non inviano payload
# WEBHOOK_DISCORD_ALERTS_HEADERS="X-Custom-Token:abc123"
# WEBHOOK_DISCORD_ALERTS_AUTH_TYPE=none   # none | bearer | basic | hmac
# WEBHOOK_DISCORD_ALERTS_AUTH_TOKEN=
# WEBHOOK_DISCORD_ALERTS_AUTH_USER=
# WEBHOOK_DISCORD_ALERTS_AUTH_PASS=
# WEBHOOK_DISCORD_ALERTS_AUTH_SECRET=

# ----------------------------------------------------------------------
# Metriche / Prometheus
# ----------------------------------------------------------------------
METRICS_ENABLED=false
METRICS_PATH=${BASE_DIR}/metrics

# ----------------------------------------------------------------------
# Opzioni collector (tutte abilitate di default)
# ----------------------------------------------------------------------
# PVE
BACKUP_CLUSTER_CONFIG=true
BACKUP_PVE_FIREWALL=true
BACKUP_VZDUMP_CONFIG=true
BACKUP_PVE_ACL=true
BACKUP_PVE_JOBS=true
BACKUP_PVE_SCHEDULES=true
BACKUP_PVE_REPLICATION=true
BACKUP_PVE_BACKUP_FILES=true
BACKUP_CEPH_CONFIG=true
BACKUP_VM_CONFIGS=true

# PBS
BACKUP_DATASTORE_CONFIGS=true
BACKUP_USER_CONFIGS=true
BACKUP_REMOTE_CONFIGS=true
BACKUP_SYNC_JOBS=true
BACKUP_VERIFICATION_JOBS=true
BACKUP_TAPE_CONFIGS=true
BACKUP_PRUNE_SCHEDULES=true
BACKUP_PXAR_FILES=true
PXAR_SCAN_DS_CONCURRENCY=3        # Number of datastores scanned in parallel for PXAR metadata
PXAR_SCAN_INTRA_CONCURRENCY=4     # Worker threads per datastore for PXAR directory/file sampling
PXAR_SCAN_FANOUT_LEVEL=2          # Directory depth for worker fan-out (1=top-level, 2=vm/ct IDs, increase for namespaces)
PXAR_SCAN_MAX_ROOTS=2048          # Maximum worker roots per datastore (limits fan-out enumeration)

# Sistema
BACKUP_NETWORK_CONFIGS=true
BACKUP_APT_SOURCES=true
BACKUP_CRON_JOBS=true
BACKUP_SYSTEMD_SERVICES=true
BACKUP_SSL_CERTS=true
BACKUP_SYSCTL_CONFIG=true
BACKUP_KERNEL_MODULES=true
BACKUP_FIREWALL_RULES=true
BACKUP_INSTALLED_PACKAGES=true
BACKUP_SCRIPT_DIR=true
BACKUP_CRITICAL_FILES=true
BACKUP_SSH_KEYS=true
BACKUP_ZFS_CONFIG=true
BACKUP_ROOT_HOME=true
BACKUP_SCRIPT_REPOSITORY=false

# ----------------------------------------------------------------------
# Percorsi personalizzati / blacklist
# ----------------------------------------------------------------------
# Dichiarazione stile Bash: uno per riga all'interno delle virgolette
CUSTOM_BACKUP_PATHS="
# /root/.config/rclone/rclone.conf
# /srv/custom-config.yaml
# /etc/custom/tool.conf
"

BACKUP_BLACKLIST="
# /root/.cache
# /root/*_tmp
# ${BASE_DIR}/log/
"

# ----------------------------------------------------------------------
# Sicurezza e permessi
# ----------------------------------------------------------------------
SKIP_PERMISSION_CHECK=false

# ==============================================================================
# Fine file – ricorda di impostare permessi restrittivi (es. chmod 600).
# ==============================================================================***
